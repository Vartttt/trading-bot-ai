"""
–£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—ñ–π –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è/–∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ–π.
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —ñ –≤ —Å–∏–º—É–ª—è—Ü—ñ—ó, —ñ –≤ —Ä–µ–∞–ª—å–Ω—ñ–π —Ç–æ—Ä–≥—ñ–≤–ª—ñ.
"""

import os
import json
from notifier.telegram_notifier import send_message

SAFE_MODE_FILE = "/tmp/safe_mode.json"


# ============================================================
# üß© –ë–µ–∑–ø–µ—á–Ω–∏–π —Ä–µ–∂–∏–º
# ============================================================
def set_safe_mode(state: bool):
    """–í–º–∏–∫–∞—î –∞–±–æ –≤–∏–º–∏–∫–∞—î –±–µ–∑–ø–µ—á–Ω–∏–π —Ä–µ–∂–∏–º."""
    with open(SAFE_MODE_FILE, "w") as f:
        json.dump({"enabled": state}, f)
    state_txt = "üü¢ –£–≤—ñ–º–∫–Ω–µ–Ω–æ" if state else "üî¥ –í–∏–º–∫–Ω–µ–Ω–æ"
    send_message(f"üõ°Ô∏è –ë–µ–∑–ø–µ—á–Ω–∏–π —Ä–µ–∂–∏–º: {state_txt}")


def is_safe_mode() -> bool:
    """–ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –±–µ–∑–ø–µ—á–Ω–∏–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–Ω–∏–π."""
    if not os.path.exists(SAFE_MODE_FILE):
        return False
    try:
        data = json.load(open(SAFE_MODE_FILE))
        return data.get("enabled", False)
    except Exception:
        return False


# ============================================================
# üìà –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ—ó
# ============================================================
def notify_open_position(symbol, side, price, leverage=1, mode="real"):
    """
    –ù–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ—ó.
    mode = 'simulation' –∞–±–æ 'real'
    """
    emoji = "üéÆ" if mode == "simulation" else "üöÄ"
    send_message(
        f"{emoji} <b>–í—ñ–¥–∫—Ä–∏—Ç–æ –ø–æ–∑–∏—Ü—ñ—é ({mode.upper()})</b>\n"
        f"üìä –ü–∞—Ä–∞: <code>{symbol}</code>\n"
        f"üìà –ù–∞–ø—Ä—è–º: <b>{side}</b>\n"
        f"üíµ –¶—ñ–Ω–∞ –≤—Ö–æ–¥—É: <code>{price:.4f}</code>\n"
        f"‚öôÔ∏è –ü–ª–µ—á–µ: x{leverage}"
    )


# ============================================================
# üìâ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ—ó
# ============================================================
def notify_close_position(symbol, profit, mode="real"):
    """
    –ù–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ—ó.
    """
    emoji = "üéÆ" if mode == "simulation" else "üí∞"
    result = "‚úÖ –ü—Ä–∏–±—É—Ç–æ–∫" if profit > 0 else "‚ùå –ó–±–∏—Ç–æ–∫"
    send_message(
        f"{emoji} <b>–ó–∞–∫—Ä–∏—Ç–æ –ø–æ–∑–∏—Ü—ñ—é ({mode.upper()})</b>\n"
        f"üìä –ü–∞—Ä–∞: <code>{symbol}</code>\n"
        f"{result}: {profit:.2f} USDT"
    )
